<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Verification</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            /* A simple background color for areas outside the app frame (on tablets/desktops) */
            background-color: #f3f4f6;
        }
        
        /* --- Animation Classes --- */
        .swoosh-in {
            animation: swooshIn 0.7s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }
        .fade-in-up {
            animation: fadeInUp 0.5s ease-out both;
        }
        
        @keyframes swooshIn {
            0% {
                opacity: 0;
                transform: scale(0.95) translateY(20px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .pulse-once {
            animation: pulse-animation 1.5s ease-out;
        }
        
        @keyframes pulse-animation {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { transform: scale(1); }
        }

        /* --- UI Polish --- */
        .certificate-bg {
            background-image:
                linear-gradient(135deg, rgba(236, 248, 255, 0.8) 0%, rgba(224, 242, 254, 0.8) 100%),
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23a1c4fd' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        #qr-reader video {
            border-radius: 0.75rem; /* Increased rounding */
            border: 3px dashed #9ca3af;
        }
        .scanner-active {
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.6);
            border-color: #3b82f6;
            transition: box-shadow 0.3s ease-in-out, border-color 0.3s ease-in-out;
        }
        .btn-primary {
            @apply bg-blue-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-blue-700 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-xl;
        }
        .btn-secondary {
            @apply bg-white text-gray-700 font-bold py-3 px-6 rounded-xl border border-gray-300 hover:bg-gray-100 hover:border-gray-400 transition-all duration-300 transform hover:-translate-y-0.5;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <!-- Mobile App Container -->
    <div class="w-full max-w-md mx-auto bg-gray-100 flex flex-col h-screen overflow-hidden sm:rounded-3xl sm:shadow-2xl sm:my-4 sm:h-[95vh] sm:max-h-[850px]">
        <!-- Header -->
        <header class="text-center p-4 border-b bg-white/70 backdrop-blur-lg sm:rounded-t-3xl flex-shrink-0 flex items-center justify-center space-x-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
            <h1 class="text-xl font-bold text-gray-900">Product Authenticator</h1>
        </header>

        <main id="app" class="flex-grow overflow-y-auto p-6 space-y-6">
            <!-- Initial View: Input and Scan options -->
            <div id="initial-view" class="bg-white p-6 rounded-2xl shadow-lg transition-all swoosh-in">
                <!-- Manual ID Input -->
                <div class="mb-4">
                    <label for="productId" class="block text-sm font-medium text-gray-700 mb-1">Enter Unique Product ID</label>
                    <div class="flex space-x-2">
                        <input type="text" id="productId" class="flex-grow w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition shadow-inner" placeholder="e.g., PROD-123-XYZ">
                        <button id="verify-btn" class="btn-primary whitespace-nowrap">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-1"><path d="M21.2 15.2c.2-1.3.2-2.7 0-4l2-1.5-2-3.5-2 1.5c-.8-.6-1.7-1.1-2.7-1.3L14 4h-4L9.8 6.3c-1 .3-1.9.7-2.7 1.3l-2-1.5-2 3.5 2 1.5c-.2 1.3-.2 2.7 0 4l-2 1.5 2 3.5 2-1.5c.8.6 1.7 1.1 2.7 1.3L10 20h4l.2-2.3c1-.3 1.9-.7 2.7-1.3l2 1.5 2-3.5-2-1.5z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                            Verify
                        </button>
                    </div>
                </div>

                <div class="flex items-center text-gray-400 my-4">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink mx-4 text-xs font-semibold">OR</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>

                <!-- QR Scanner Section -->
                <div id="scanner-section">
                    <button id="scan-qr-btn" class="w-full btn-secondary flex items-center justify-center pulse-once">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path><rect x="7" y="7" width="10" height="10" rx="1"></rect></svg>
                        Scan QR Code
                    </button>
                    <div id="qr-reader" class="mt-4 w-full mx-auto" style="display: none;"></div>
                    <div id="qr-scan-result" class="text-center mt-2"></div>
                </div>
            </div>

            <!-- Status/Error View -->
            <div id="status-view" class="text-center p-6 bg-white rounded-2xl shadow-lg" style="display: none;">
                <p id="status-message" class="text-lg font-medium"></p>
            </div>
            
            <!-- Result View: Product Details -->
            <div id="result-view" class="space-y-6" style="display: none;">
                <!-- Product Details Card -->
                <div class="bg-white p-6 rounded-2xl shadow-lg fade-in-up" style="animation-delay: 100ms;">
                    <div class="flex flex-col">
                        <img id="product-image" src="" alt="Product Image" class="w-full h-auto object-cover rounded-xl mb-4 flex-shrink-0 shadow-md">
                        <div class="flex-grow">
                            <h2 id="product-name" class="text-2xl font-bold mb-2"></h2>
                            <p id="product-description" class="text-gray-600 mb-4 text-sm"></p>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div class="bg-gray-50 p-3 rounded-xl border">
                                    <span class="font-semibold text-gray-500 block">Serial Number</span>
                                    <span id="product-serial" class="font-mono"></span>
                                </div>
                                <div class="bg-gray-50 p-3 rounded-xl border">
                                    <span class="font-semibold text-gray-500 block">Manufacture Date</span>
                                    <span id="product-mfg-date"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Digital Certificate Card -->
                <div class="certificate-bg border-2 border-blue-200 p-6 rounded-2xl shadow-lg relative overflow-hidden fade-in-up" style="animation-delay: 200ms;">
                    <div class="flex items-center mb-4">
                        <svg class="w-12 h-12 text-green-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                        <div>
                            <h3 class="text-xl font-bold text-gray-800">Digital Authentication Certificate</h3>
                            <p class="text-green-700 font-semibold">Product Verified & Authentic</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">This certifies that the product with the specified serial number has been authenticated through our secure verification system.</p>
                </div>

                <!-- Product Journey Card -->
                <div class="bg-white p-6 rounded-2xl shadow-lg fade-in-up" style="animation-delay: 300ms;">
                     <div class="flex items-center mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-blue-600 mr-3"><path d="M2 17L4.08 11.13a2 2 0 0 1 1.76-1.13H14a2 2 0 0 1 2 2v4H2Z"></path><path d="M14 9.5h5.31a2 2 0 0 1 1.76 1.13L22 17H14Z"></path><path d="M2 17v-1a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v1"></path><circle cx="7" cy="20" r="2"></circle><circle cx="17" cy="20" r="2"></circle></svg>
                        <h3 class="text-lg font-semibold">Product Journey</h3>
                    </div>
                    <div id="product-history" class="relative border-l-2 border-blue-200 ml-3 space-y-6">
                        <!-- History items will be injected here by JS -->
                    </div>
                </div>

                <!-- Ingredients/Components Card -->
                 <div class="bg-white p-6 rounded-2xl shadow-lg fade-in-up" style="animation-delay: 400ms;">
                     <div class="flex items-center mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-blue-600 mr-3"><path d="M15.4 2a2 2 0 0 1 2.2 3.8l-1.4 1.4A2 2 0 1 1 12.4 3l1.4-1.4A2 2 0 0 1 15.4 2z"></path><path d="m21.4 12.6-6-6a2 2 0 0 0-2.8 0L2.2 17a2 2 0 0 0 0 2.8l6 6a2 2 0 0 0 2.8 0l10.4-10.4a2 2 0 0 0 0-2.8z"></path><path d="m14.5 7.5 3 3"></path></svg>
                        <h3 class="text-lg font-semibold">Key Components / Ingredients</h3>
                    </div>
                     <div id="product-ingredients" class="flex flex-wrap gap-2">
                        <!-- Ingredient tags will be injected here by JS -->
                    </div>
                </div>


                <!-- Manufacturer Signature Card -->
                <div class="bg-white p-6 rounded-2xl shadow-lg fade-in-up" style="animation-delay: 500ms;">
                     <div class="flex items-center mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-blue-600 mr-3"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="m12 14 4 6 2-2-4-6-2 2"></path><path d="M12 14l-1.5 1.5"></path></svg>
                        <h3 class="text-lg font-semibold">Manufacturer's Digital Signature</h3>
                    </div>
                    <div id="emudra-signature-block" class="border-2 border-green-300 bg-green-50/50 p-4 rounded-xl flex items-start space-x-4">
                        <div class="text-center flex-shrink-0 pt-1">
                           <svg class="w-12 h-12 text-green-600 mx-auto" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19.965 8.521C19.988 8.347 20 8.173 20 8c0-2.21-1.79-4-4-4-1.293 0-2.438.616-3.16 1.574A3.984 3.984 0 008 4c-2.21 0-4 1.79-4 4 0 .173.012.347.035.521A6.996 6.996 0 001 15c0 3.866 3.134 7 7 7h8c3.866 0 7-3.134 7-7a6.996 6.996 0 00-3.035-6.479zM15 15H9v-2h6v2zm-1-4H9V9h5v2z"></path></svg>
                           <p class="text-xs font-bold text-green-800 mt-1">e-Mudra</p>
                        </div>
                         <div class="flex-grow">
                           <p class="font-semibold text-gray-800">Digitally Signed by: <span id="sig-signer" class="font-normal"></span></p>
                           <p class="text-sm text-gray-600">Timestamp: <span id="sig-timestamp" class="font-mono text-xs"></span></p>
                           <p class="text-sm text-gray-600 mt-2">Signature Value:</p>
                            <div class="flex items-center bg-gray-100 p-2 rounded-lg mt-1">
                                <pre id="manufacturer-signature" class="text-xs text-gray-700 font-mono break-all flex-grow whitespace-pre-wrap"></pre>
                                <button id="copy-sig-btn" class="ml-4 p-2 rounded-md hover:bg-gray-200 transition" title="Copy to Clipboard">
                                   <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Blockchain Hash Card -->
                <div class="bg-white p-6 rounded-2xl shadow-lg fade-in-up" style="animation-delay: 600ms;">
                    <h3 class="text-lg font-semibold mb-2">Blockchain Verification Hash</h3>
                    <p class="text-sm text-gray-500 mb-3">This immutable hash represents the product's authentication record on the blockchain.</p>
                    <div class="flex items-center bg-gray-100 p-2 rounded-lg">
                        <pre id="product-hash" class="text-xs text-gray-700 font-mono break-all flex-grow whitespace-pre-wrap"></pre>
                        <button id="copy-hash-btn" class="ml-4 p-2 rounded-md hover:bg-gray-200 transition" title="Copy to Clipboard">
                           <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </div>
                </div>

                <div class="text-center pt-4 fade-in-up" style="animation-delay: 700ms;">
                     <button id="reset-btn" class="btn-secondary">Scan Another Product</button>
                </div>
            </div>
        </main>

        <footer class="text-center p-4 text-xs text-gray-400 flex-shrink-0 bg-white/70 border-t sm:rounded-b-3xl">
            <p>&copy; 2025 AuthentiChain Inc. All rights reserved.</p>
        </footer>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const initialView = document.getElementById('initial-view');
            const statusView = document.getElementById('status-view');
            const statusMessage = document.getElementById('status-message');
            const resultView = document.getElementById('result-view');
            
            const productIdInput = document.getElementById('productId');
            const verifyBtn = document.getElementById('verify-btn');
            const scanQrBtn = document.getElementById('scan-qr-btn');
            const resetBtn = document.getElementById('reset-btn');
            const copyHashBtn = document.getElementById('copy-hash-btn');
            const copySigBtn = document.getElementById('copy-sig-btn');

            const qrReaderElement = document.getElementById('qr-reader');
            const qrScanResult = document.getElementById('qr-scan-result');
            
            let html5QrCode;
            let currentProduct = null;

            // --- MOCK DATABASE ---
            // In a real application, this would be an API call to a backend service.
            const productDatabase = {
                "PROD-123-XYZ": {
                    name: "Chronos Tourbillon Watch",
                    description: "A masterpiece of mechanical engineering, featuring a gravity-defying tourbillon and a sapphire crystal case. Precision and elegance combined.",
                    serial: "SN-A78B3C",
                    mfgDate: "2025-03-15",
                    image: "https://images.unsplash.com/photo-1523275335684-37898b6baf30?q=80&w=1000&auto=format&fit=crop",
                    hash: "0x4a2e8c6b7f9d1a3c5e8b0f7d2a6c9e1b4f3d7a9c8b6e2d1f0a5c8b7e4d3f2a1b",
                    manufacturerSignature: {
                        signer: "Dr. Alistair Finch (Head of Quality)",
                        timestamp: "2025-03-15T10:30:00Z",
                        value: "f4d3a2e1c9b8f7d6e5a4b3c2d1e0f9a8c7b6a5e4d3c2b1a0"
                    },
                    history: [
                        { status: "Manufactured", date: "2025-03-15", location: "Geneva, CH" },
                        { status: "Shipped to Distributor", date: "2025-03-20", location: "Global Logistics Hub" },
                        { status: "In Retail", date: "2025-04-01", location: "Mumbai, IN" }
                    ],
                    ingredients: ["Sapphire Crystal", "316L Stainless Steel", "Tourbillon Movement", "Italian Leather"]
                },
                "PROD-456-ABC": {
                    name: "Aura Noise-Cancelling Headphones",
                    description: "Immerse yourself in pure sound with our state-of-the-art active noise cancellation technology. 40-hour battery life and plush comfort.",
                    serial: "SN-F45G6H",
                    mfgDate: "2025-05-20",
                    image: "https://images.unsplash.com/photo-1505740420928-5e560c06d30e?q=80&w=1000&auto=format&fit=crop",
                    hash: "0x9d1a3c5e8b0f7d2a6c9e1b4f3d7a9c8b6e2d1f0a5c8b7e4d3f2a1b4a2e8c6b7f",
                    manufacturerSignature: {
                        signer: "Jian Li (Audio Engineer Lead)",
                        timestamp: "2025-05-20T14:00:00Z",
                        value: "b8c7d6e5f4a3b2c1d0e9f8a7g6h5i4j3k2l1m0n9o8p7"
                    },
                     history: [
                        { status: "Assembled", date: "2025-05-20", location: "Shenzhen, CN" },
                        { status: "Quality Checked", date: "2025-05-21", location: "Shenzhen, CN" },
                        { status: "Shipped", date: "2025-05-25", location: "International Air Freight" }
                    ],
                    ingredients: [" neodymium magnets", "Memory Foam Earpads", "Anodized Aluminum", "AuraSoundâ„¢ Chipset"]
                },
                 "PROD-789-QWE": {
                    name: "Nomad Pro Leather Backpack",
                    description: "Crafted from full-grain Italian leather, this backpack is the perfect blend of timeless style and modern functionality.",
                    serial: "SN-K12L3M",
                    mfgDate: "2025-01-30",
                    image: "https://images.unsplash.com/photo-1553062407-98eeb6814762?q=80&w=800&auto=format&fit=crop",
                    hash: "0x2a6c9e1b4f3d7a9c8b6e2d1f0a5c8b7e4d3f2a1b9d1a3c5e8b0f7d2a4a2e8c6b",
                    manufacturerSignature: {
                        signer: "Isabella Rossi (Artisan Crafter)",
                        timestamp: "2025-01-30T09:15:00Z",
                        value: "e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2"
                    },
                    history: [
                        { status: "Leather Tanned", date: "2025-01-15", location: "Florence, IT" },
                        { status: "Hand-Stitched", date: "2025-01-30", location: "Florence, IT" },
                        { status: "Exported", date: "2025-02-05", location: "Milan, IT" }
                    ],
                    ingredients: ["Full-Grain Italian Leather", "YKK Zippers", "Padded Cotton Canvas", "Solid Brass Hardware"]
                }
            };


            // --- FUNCTIONS ---
            
            // Shows a status message (e.g., loading, error)
            function showStatus(message, isError = false) {
                initialView.style.display = 'none';
                resultView.style.display = 'none';
                statusView.style.display = 'block';
                statusMessage.textContent = message;
                statusMessage.className = isError ? 'text-lg font-medium text-red-600' : 'text-lg font-medium text-blue-600';
            }
            
            // Finds a product in the mock database
            function findProduct(id) {
                showStatus('Verifying product...');
                
                // Simulate network delay
                setTimeout(() => {
                    const product = productDatabase[id.trim()];
                    if (product) {
                        currentProduct = product;
                        displayProductDetails(product);
                    } else {
                        currentProduct = null;
                        showStatus(`Product with ID "${id}" not found. Please check the ID or try scanning again.`, true);
                        // Add a button to go back
                        const backButton = document.createElement('button');
                        backButton.textContent = 'Try Again';
                        backButton.className = 'btn-secondary mt-4';
                        backButton.onclick = resetApp;
                        statusMessage.appendChild(document.createElement('br'));
                        statusMessage.appendChild(backButton);
                    }
                }, 1000);
            }

            // Displays the product details on the screen
            function displayProductDetails(product) {
                document.getElementById('product-name').textContent = product.name;
                document.getElementById('product-description').textContent = product.description;
                document.getElementById('product-serial').textContent = product.serial;
                document.getElementById('product-mfg-date').textContent = product.mfgDate;
                document.getElementById('product-image').src = product.image;
                document.getElementById('product-hash').textContent = product.hash;
                
                // Populate new fields
                document.getElementById('sig-signer').textContent = product.manufacturerSignature.signer;
                document.getElementById('sig-timestamp').textContent = new Date(product.manufacturerSignature.timestamp).toLocaleString();
                document.getElementById('manufacturer-signature').textContent = product.manufacturerSignature.value;

                const historyContainer = document.getElementById('product-history');
                const ingredientsContainer = document.getElementById('product-ingredients');
                
                historyContainer.innerHTML = ''; // Clear previous results
                ingredientsContainer.innerHTML = ''; // Clear previous results

                // Populate History
                product.history.forEach((item, index) => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'pl-8 relative fade-in-up';
                    historyItem.style.animationDelay = `${index * 100}ms`;
                    historyItem.innerHTML = `
                        <div class="absolute -left-1.5 top-1 w-4 h-4 bg-blue-500 rounded-full border-4 border-white shadow"></div>
                        <p class="font-semibold text-gray-800">${item.status}</p>
                        <p class="text-sm text-gray-500">${item.location}</p>
                        <p class="text-xs text-gray-400 font-mono">${item.date}</p>
                    `;
                    historyContainer.appendChild(historyItem);
                });

                // Populate Ingredients
                product.ingredients.forEach(item => {
                    const ingredientTag = document.createElement('span');
                    ingredientTag.className = 'bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1.5 rounded-full shadow-sm';
                    ingredientTag.textContent = item;
                    ingredientsContainer.appendChild(ingredientTag);
                });


                initialView.style.display = 'none';
                statusView.style.display = 'none';
                resultView.style.display = 'block';
            }
            
            // Resets the application to its initial state
            function resetApp() {
                stopQrScanner();
                initialView.style.display = 'block';
                statusView.style.display = 'none';
                resultView.style.display = 'none';
                productIdInput.value = '';
                currentProduct = null;
                qrReaderElement.style.display = 'none';
                qrReaderElement.classList.remove('scanner-active');
                scanQrBtn.disabled = false;
                qrScanResult.innerHTML = '';
            }

            // Starts the QR code scanner
            function startQrScanner() {
                qrReaderElement.style.display = 'block';
                scanQrBtn.disabled = true; // Prevent multiple clicks
                
                // Initialize the scanner if it hasn't been already
                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode("qr-reader");
                }
                
                qrReaderElement.classList.add('scanner-active');
                qrScanResult.innerHTML = `<span class="text-blue-600">Starting camera...</span>`;
                
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                
                const onScanSuccess = (decodedText, decodedResult) => {
                    qrScanResult.innerHTML = `<span class="text-green-600">Scan successful!</span>`;
                    stopQrScanner();
                    productIdInput.value = decodedText; // Populate the input field
                    findProduct(decodedText);
                };
                
                const onScanFailure = (error) => {
                    // This function is called frequently, so we don't log every error.
                    // qrScanResult.innerHTML = `<span class="text-gray-500">Scanning...</span>`;
                };

                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                    .catch(err => {
                        qrScanResult.innerHTML = `<span class="text-red-600">Camera error: ${err}. Please grant permission.</span>`;
                        qrReaderElement.classList.remove('scanner-active');
                        scanQrBtn.disabled = false;
                    });
            }

            // Stops the QR code scanner
            function stopQrScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {
                        console.log("QR Code scanning stopped.");
                    }).catch(err => {
                        console.error("Failed to stop QR scanner.", err);
                    }).finally(() => {
                        qrReaderElement.style.display = 'none';
                        qrReaderElement.classList.remove('scanner-active');
                        scanQrBtn.disabled = false;
                    });
                }
            }
            
            // --- EVENT LISTENERS ---

            // Verify button click
            verifyBtn.addEventListener('click', () => {
                const productId = productIdInput.value;
                if (productId) {
                    findProduct(productId);
                } else {
                    // Simple validation feedback
                    productIdInput.classList.add('border-red-500', 'ring-red-500');
                    setTimeout(() => productIdInput.classList.remove('border-red-500', 'ring-red-500'), 2000);
                }
            });
            
            // Allow pressing Enter in the input field
            productIdInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    verifyBtn.click();
                }
            });

            // Scan QR button click
            scanQrBtn.addEventListener('click', () => {
                if (qrReaderElement.style.display === 'none') {
                    startQrScanner();
                } else {
                    stopQrScanner();
                }
            });

            // Reset button click
            resetBtn.addEventListener('click', resetApp);
            
            // Copy hash button click
            copyHashBtn.addEventListener('click', (e) => {
                const hashText = document.getElementById('product-hash').textContent;
                navigator.clipboard.writeText(hashText).then(() => {
                    e.currentTarget.title = 'Copied!';
                    setTimeout(() => { e.currentTarget.title = 'Copy to Clipboard'; }, 2000);
                });
            });

            // Copy signature button click
            copySigBtn.addEventListener('click', (e) => {
                const sigText = document.getElementById('manufacturer-signature').textContent;
                 navigator.clipboard.writeText(sigText).then(() => {
                    e.currentTarget.title = 'Copied!';
                    setTimeout(() => { e.currentTarget.title = 'Copy to Clipboard'; }, 2000);
                });
            });
        });
    </script>
</body>
</html>

